name: Build React Native APK

on:
  push:
    branches:
      - main

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Install dependencies
      - name: Install Dependencies
        run: |
          npm install -g yarn
          npm install -g react-native-cli
          yarn install
          cd android
          chmod +x gradlew

      # Install Android Command Line Tools in a directory with full access
      - name: Install Android SDK
        run: |
          # Create a directory in the user's home directory where we have full access
          mkdir -p $HOME/android-sdk/cmdline-tools
          cd $HOME/android-sdk

          # Download Android Command Line Tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip

          # Extract and move the files to the correct location
          unzip commandlinetools-linux-9477386_latest.zip -d cmdline-tools
          mv cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest

          # Clean up the zip file
          rm -f commandlinetools-linux-9477386_latest.zip

          # Add Android SDK to PATH
          echo 'export ANDROID_HOME=$HOME/android-sdk' >> ~/.bashrc
          echo 'export PATH=$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools' >> ~/.bashrc
          source ~/.bashrc

          # Accept Android SDK licenses
          yes | sdkmanager --licenses

          # Install required Android SDK components
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      # Build Debug APK
      - name: Build Debug APK
        run: ./gradlew assembleDebug
        working-directory: android

      # Upload APK as an artifact
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
